---
title: "SWS_Treatment_v3"
author: "Elaine P."
date: "16/06/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(ggpubr)
library(car)
library(haven)
library(data.table)
library(visreg)
library(dplyr)
library(tidyr)
library(reshape2)
library(rstatix)
library(JWileymisc)
library(lme4)
library(lmerTest)
library(multilevelTools)
library(tidyverse)
library(Rmisc)


SWS_data <- read.table("../Tables/CTET_SWdetection_thr90_byE_P2P_avDens_behav_vec_full_v3.txt", header = TRUE, sep = ",", stringsAsFactors = FALSE)

names(SWS_data)[names(SWS_data) == "Drug"] <- "Treatment"

SWS_data$Treatment<-as.factor(SWS_data$Treatment)

SWS_data$Treatment<-relevel(SWS_data$Treatment,"PLA")


```



```{r}

SWS_data2<-aggregate(P2P ~ SubID+Treatment+BlockN, data=SWS_data, FUN=mean)
##Peak to Peak 
lm.pp0 <- lmer(P2P ~ 1 + (1|SubID), data = SWS_data2, REML =FALSE)

##Effects of block number on peak to peak 
lm.pp1 <- lmer(P2P  ~ 1  + BlockN + (1|SubID), data = SWS_data2, REML = FALSE)

##Effects of block number and drug on peak to peak 
lm.pp2 <- lmer(P2P  ~ 1  + BlockN + Treatment + (1|SubID), data = SWS_data2, REML = FALSE)

##Effects of the interaction between block number and drug on peak to peak
lm.pp3 <- lmer(P2P  ~ 1 + BlockN*Treatment + (1|SubID), data = SWS_data2, REML = FALSE)


##Anova to see which one has the most interaction
anova(lm.pp0,lm.pp1,lm.pp2, lm.pp3)

lm.pp2 <- lmer(P2P  ~ 1 + BlockN + Treatment + (1|SubID), data = SWS_data2, REML = TRUE)
summary(lm.pp2)
confint(lm.pp2, method = "Wald", oldNames = FALSE)

lm.pp3 <- lmer(P2P  ~ 1 + BlockN*Treatment + (1|SubID), data = SWS_data2, REML = TRUE)
summary(lm.pp3)
confint(lm.pp3, method = "Wald", oldNames = FALSE)

```
- According to AIC, lm.pp3 is the winning model, whilst BIC says lm.pp2 is the winning model 
-Showed different results; 
  -for the non-interaction model (lm.pp2), block number and all the treatments had a significant effect (p <.001) EXCEPT MPH 
  -for the interaction model (lm.pp3), only MPH was significant (p= .01) and its interaction with block number (p<.001)
  
  
```{r}
SWS_data3<-aggregate(PosSlope ~ SubID+Treatment+BlockN, data=SWS_data, FUN=mean)
##Peak to Peak 
lm.ps0 <- lmer(PosSlope ~ 1 + (1|SubID), data = SWS_data3, REML =FALSE)

##Effects of block number on peak to peak 
lm.ps1 <- lmer(PosSlope   ~ 1  + BlockN + (1|SubID), data = SWS_data3, REML = FALSE)

##Effects of block number and drug on peak to peak 
lm.ps2 <- lmer(PosSlope   ~ 1  + BlockN + Treatment + (1|SubID), data = SWS_data3, REML = FALSE)

##Effects of the interaction between block number and drug on peak to peak
lm.ps3 <- lmer(PosSlope   ~ 1 + BlockN*Treatment + (1|SubID), data = SWS_data3, REML = FALSE)


##Anova to see which one has the most interaction
anova(lm.ps0,lm.ps1,lm.ps2, lm.ps3)

lm.ps2 <- lmer(PosSlope   ~ 1  + BlockN + Treatment + (1|SubID), data = SWS_data3, REML = TRUE)
summary(lm.ps2)
confint(lm.ps2, method = "Wald", oldNames = FALSE)

lm.ps3 <- lmer(PosSlope   ~ 1 + BlockN*Treatment + (1|SubID), data = SWS_data3, REML = TRUE)
summary(lm.ps3)
confint(lm.ps3, method = "Wald", oldNames = FALSE)


```
  - According to AIC, lm.ps3 is the winning model, whilst BIC says lm.ps2 is the winning model 
-Showed different results; 
  -for the non-interaction model (lm.ps2), block number and all the treatments had a significant effect (p <.001) EXCEPT CIT 
  -for the interaction model (lm.ps3), CIT was non-significant (p= .089) and all interactions with block number and treatment were non-signifiant 
  -model failed to converge for lm.ps2
  
  
```{r}
SWS_data4<-aggregate(NegSlope ~ SubID+Treatment+BlockN, data=SWS_data, FUN=mean)
##Peak to Peak 
lm.ns0 <- lmer(NegSlope ~ 1 + (1|SubID), data = SWS_data4, REML =FALSE)

##Effects of block number on peak to peak 
lm.ns1 <- lmer(NegSlope   ~ 1  + BlockN + (1|SubID), data = SWS_data4, REML = FALSE)

##Effects of block number and drug on peak to peak 
lm.ns2 <- lmer(NegSlope   ~ 1  + BlockN + Treatment + (1|SubID), data = SWS_data4, REML = FALSE)

##Effects of the interaction between block number and drug on peak to peak
lm.ns3 <- lmer(NegSlope   ~ 1 + BlockN*Treatment + (1|SubID), data = SWS_data4, REML = FALSE)


##Anova to see which one has the most interaction
anova(lm.ns0,lm.ns1,lm.ns2, lm.ns3)

lm.ns2 <- lmer(NegSlope   ~ 1  + BlockN + Treatment + (1|SubID), data = SWS_data4, REML = TRUE)
summary(lm.ns2)
confint(lm.ns2, method = "Wald", oldNames = FALSE)

```
- second model was the winning model (lm.ns2) according to AIC and BIC
-  Block number and treatments except citalopream were significant 


```{r}
##Graph of the effects of block number and drug on peak to peak 
p2p.graph <- summarySE(SWS_data2, measurevar = "P2P", groupvars = c("BlockN", "Treatment"))
p2p.graph$Treatment<-ordered(p2p.graph$Treatment, c("PLA","MPH","ATM","CIT"))


##Graph with Standard Error 
ggplot(p2p.graph, aes(x = BlockN, y = P2P, colour = Treatment)) + geom_point() + geom_line() + xlab("Block Number")+ geom_ribbon(aes(ymin = P2P-se, ymax = P2P+se, fill = Treatment), alpha = .35, linetype = 0) + scale_fill_manual(values = c("#666666", "#d95f02", "#7570b3", "#1b9e77")) + scale_colour_manual(values = c("#666666", "#d95f02", "#7570b3", "#1b9e77")) + scale_x_continuous(breaks = c(1:10))+ scale_y_continuous(labels = scales::number_format(accuracy = .01)) + theme_classic() +theme(panel.border = element_blank(),  legend.position = "none", axis.title=element_text(size=14),axis.text=element_text(size=14)) +ylab("Peak to Peak")

ggsave(file="../Figures/CTET_LinePlot_P2P.png", 
       width = 30/2,
      height = 18/2,
    units = c("cm"))

##Barplot 
p2p2.graph <- summarySE(SWS_data2, measurevar = "P2P", groupvars = c( "Treatment"))
p2p2.graph$Treatment<-ordered(p2p2.graph$Treatment,c("PLA","MPH","ATM","CIT"))

ggplot(data=p2p2.graph, aes(x=Treatment, y=P2P, fill = Treatment)) +
  geom_bar(stat="identity") + geom_errorbar(aes(ymin = P2P-se, ymax = P2P+se), width = .5, size = .6) + scale_fill_discrete( name = "Treatment", breaks = c("PLA", "MPH", "ATM", "CIT"), labels = c("Placebo", "Methylphenidate", "Atomoxetine", "Citalopram")) + ylab("Mean Peak to Peak")+ scale_fill_manual(values = c("#666666", "#d95f02", "#7570b3", "#1b9e77")) + coord_cartesian(ylim =c(35, 40)) + scale_y_continuous(labels = scales::number_format(accuracy = .01)) + theme_classic()+theme(legend.position = "none",axis.title=element_text(size=14),axis.text=element_text(size=14), axis.title.x = element_blank())

ggsave(file="../Figures/CTET_BarPlot_P2P.png", dpi = 600, 
       width = 15/2,
      height = 18/2,
    units = c("cm"))
```

```{r}
##Graph of the effects of block number and drug on positive slope 
ps.graph <- summarySE(SWS_data3, measurevar = "PosSlope", groupvars = c("BlockN", "Treatment"))
ps.graph$Treatment<-ordered(ps.graph$Treatment, c("PLA","MPH","ATM","CIT"))


##Graph with Standard Error 
ggplot(ps.graph, aes(x = BlockN, y = PosSlope, colour = Treatment)) + geom_point() + geom_line() + xlab("Block Number")+ geom_ribbon(aes(ymin = PosSlope-se, ymax = PosSlope+se, fill = Treatment), alpha = .35, linetype = 0) + scale_fill_manual(values = c("#666666", "#d95f02", "#7570b3", "#1b9e77")) + scale_colour_manual(values = c("#666666", "#d95f02", "#7570b3", "#1b9e77")) + scale_x_continuous(breaks = c(1:10))+ scale_y_continuous(labels = scales::number_format(accuracy = .01)) + theme_classic() +theme(panel.border = element_blank(), legend.position = "none", axis.title=element_text(size=14),axis.text=element_text(size=14)) +ylab("Positive Slope")

ggsave(file="../Figures/CTET_LinePlot_PosSlope.png", 
       width = 30/2,
      height = 18/2,
    units = c("cm"))

##Barplot 
ps2.graph <- summarySE(SWS_data3, measurevar = "PosSlope", groupvars = c( "Treatment"))
ps2.graph$Treatment<-ordered(ps2.graph$Treatment,c("PLA","MPH","ATM","CIT"))

ggplot(data=ps2.graph, aes(x=Treatment, y=PosSlope, fill = Treatment)) +
  geom_bar(stat="identity") + geom_errorbar(aes(ymin = PosSlope-se, ymax = PosSlope+se), width = .5, size = .6) + scale_fill_discrete( name = "Treatment", breaks = c("PLA", "MPH", "ATM", "CIT"), labels = c("Placebo", "Methylphenidate", "Atomoxetine", "Citalopram")) + ylab("Mean Positive Slope")+ scale_fill_manual(values = c("#666666", "#d95f02", "#7570b3", "#1b9e77")) + coord_cartesian(ylim =c(350, 450)) + scale_y_continuous(labels = scales::number_format(accuracy = .01)) + theme_classic()+theme(legend.position = "none",axis.title=element_text(size=14),axis.text=element_text(size=14), axis.title.x = element_blank())

ggsave(file="../Figures/CTET_BarPlot_PosSlope.png", dpi = 600, 
       width = 15/2,
      height = 18/2,
    units = c("cm"))
```


```{r}
##Graph of the effects of block number and drug on negative slope 
ns.graph <- summarySE(SWS_data4, measurevar = "NegSlope", groupvars = c("BlockN", "Treatment"))
ns.graph$Treatment<-ordered(ns.graph$Treatment, c("PLA","MPH","ATM","CIT"))


##Graph with Standard Error 
ggplot(ns.graph, aes(x = BlockN, y = NegSlope, colour = Treatment)) + geom_point() + geom_line() + xlab("Block Number")+ geom_ribbon(aes(ymin = NegSlope-se, ymax = NegSlope+se, fill = Treatment), alpha = .35, linetype = 0) + scale_fill_manual(values = c("#666666", "#d95f02", "#7570b3", "#1b9e77")) + scale_colour_manual(values = c("#666666", "#d95f02", "#7570b3", "#1b9e77")) + scale_x_continuous(breaks = c(1:10))+ scale_y_continuous(labels = scales::number_format(accuracy = .01)) + theme_classic() +theme(panel.border = element_blank(), legend.position = "none", axis.title=element_text(size=14),axis.text=element_text(size=14)) +ylab("Negaative Slope")

ggsave(file="../Figures/CTET_LinePlot_NegSlope.png", 
       width = 30/2,
      height = 18/2,
    units = c("cm"))


##Barplot 
ns2.graph <- summarySE(SWS_data4, measurevar = "NegSlope", groupvars = c( "Treatment"))
ns2.graph$Treatment<-ordered(ns2.graph$Treatment,c("PLA","MPH","ATM","CIT"))

ggplot(data=ns2.graph, aes(x=Treatment, y=NegSlope, fill = Treatment)) +
  geom_bar(stat="identity") + geom_errorbar(aes(ymin = NegSlope-se, ymax = NegSlope+se), width = .5, size = .6) + scale_fill_discrete( name = "Treatment", breaks = c("PLA", "MPH", "ATM", "CIT"), labels = c("Placebo", "Methylphenidate", "Atomoxetine", "Citalopram")) + ylab("Mean Negative Slope")+ scale_fill_manual(values = c("#666666", "#d95f02", "#7570b3", "#1b9e77")) + coord_cartesian(ylim =c(300, 430)) + scale_y_continuous(labels = scales::number_format(accuracy = .01)) + theme_classic()+theme(legend.position = "none",axis.title=element_text(size=14),axis.text=element_text(size=14), axis.title.x = element_blank())


ggsave(file="../Figures/CTET_BarPlot_NegSlope.png", dpi = 600, 
       width = 15/2,
      height = 18/2,
    units = c("cm"))
```