---
title: "SWS_Treatment"
author: "Elaine P."
date: "19/05/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(ggpubr)
library(car)
library(haven)
library(data.table)
library(visreg)
library(dplyr)
library(tidyr)
library(reshape2)
library(rstatix)
library(JWileymisc)
library(lme4)
library(lmerTest)
library(multilevelTools)
library(tidyverse)

library(remotes)
remotes::install_github("neuroconductor/eegUtils")

SWS_data <- read.table("../Tables/CTET_SWdetection_thr90_allE_P2P_vec.txt", header = TRUE, sep = ",", stringsAsFactors = FALSE)

names(SWS_data)[names(SWS_data) == "Drug"] <- "Treatment"

SWS_data$Treatment<-as.factor(SWS_data$Treatment)

SWS_data$Treatment<-relevel(SWS_data$Treatment,"PLA")
```

```{r}
##Summary descriptive statistics (mean/SD, or number/frequency)
egltable(c("Treatment", "SWdens", "Elec"), data = SWS_data, strict=FALSE)
```


```{r}
##Slow wave density 

lm.sw0 <- lmer(SWdens ~ 1 + (1|SubID), data = SWS_data, REML = TRUE)

##Effects of drug on slow wave density
lm.sw1 <- lmer(SWdens  ~ 1 + Treatment + (1|SubID), data = SWS_data, REML = TRUE)


##Effects of drug and electrode interaction on slow wave density
lm.sw2 <- lmer(SWdens  ~ 1 + Treatment * Elec + (1|SubID), data = SWS_data, REML = TRUE)


##Anova to see which one has the most interaction
anova(lm.sw0,lm.sw1,lm.sw2)
summary(lm.sw1)
confint(lm.sw2, method = "Wald", oldNames = FALSE)

## Normality plot of residuals 
hist(residuals(lm.sw2))
boxplot(residuals(lm.sw2))
qqnorm(resid(lm.sw2))
qqline(resid(lm.sw2))
plot(lm.sw2)
plot(fitted(lm.sw2), resid(lm.sw2))

```

```{r}
##Graph of the interaction between treatment and electrodes on slow wave density
aggdata_SW <- aggregate(SWS_data$SWdens,
    by = list(Treatment = SWS_data$Treatment),
    FUN = function(x) c(mean = mean(x), sd = sd(x),
                        n = length(x)))
aggdata_SW <- do.call(data.frame, aggdata_SW)
aggdata_SW$se <- aggdata_SW$x.sd / sqrt(aggdata_SW$x.n)

ggplot(aggdata_SW) +
    geom_bar( aes(x=Treatment, y=x.mean, fill = Treatment), stat="identity", alpha=0.7) +
    geom_errorbar( aes(x=Treatment, ymin=x.mean-se, ymax=x.mean+se), width=0.1, colour="black", alpha=0.9, size=1.3)


aggdata_SW2 <- aggregate(SWS_data$SWdens,
    by = list(Elec = SWS_data$Elec, Treatment = SWS_data$Treatment),
    FUN = function(x) c(mean = mean(x), sd = sd(x),
                        n = length(x)))
aggdata_SW2 <- do.call(data.frame, aggdata_SW2)

ggplot(aggdata_SW2, aes(x = Elec, y = x.mean, colour = Treatment)) + geom_point() + geom_line() + scale_colour_brewer(palette = "Dark2") + scale_fill_brewer(palette = "Dark2") + ggtitle("Slow wave density according to electrodes and treatment") + ylab("Slow Wave Density") + xlab("Electrode")


```

```{r}
#source('/Users/tand0009/Work/local/eegUtils/R/topoplot.R')
aggdata_topo<-aggregate(SWS_data$SWdens, list(Elec=SWS_data$Elec), mean,na.rm=TRUE)
colnames(aggdata_topo)<-c("electrode","amplitude")
aggdata_topo$x<-c(-0.152969000000000,0.152969000000000,-0.264503000000000,0.264503000000000,0,-0.112500000000000,0.112500000000000,-0.225000000000000,0.225000000000000,-0.337500000000000,0.337500000000000,-0.110678000000000,0.110678000000000,-0.215938000000000,0.215938000000000,-0.328783000000000,0.328783000000000,0,0,-0.0916160000000000,0.0916160000000000,-0.184692000000000,0.184692000000000,-0.276864000000000,0.276864000000000,-0.364058000000000,0.364058000000000,-0.110678000000000,0.110678000000000,-0.215938000000000,0.215938000000000,-0.328783000000000,0.328783000000000,0,-0.139058000000000,0.139058000000000,0,-0.427975000000000,0.427975000000000,0,0,-0.139058000000000,0.139058000000000,0,-0.0916160000000000,0.430900000000000,0.0916160000000000,-0.184692000000000,0.184692000000000,-0.276864000000000,0.276864000000000,-0.364058000000000,0.364058000000000,-0.430900000000000,-0.152969000000000,0.152969000000000,-0.264503000000000,0.264503000000000,0,0,-0.450000000000000,0.450000000000000,-0.427975000000000,0.427975000000000)
aggdata_topo$y<-c(0.341595000000000,0.341595000000000,0.373607000000000,0.373607000000000,0.350000000000000,0.0500000000000000,0.0500000000000000,0.0500000000000000,0.0500000000000000,0.0500000000000000,0.0500000000000000,-0.0483800000000000,-0.0483800000000000,-0.0520590000000000,-0.0520590000000000,-0.0621850000000000,-0.0621850000000000,-0.0500000000000000,0.0500000000000000,0.251562000000000,0.251562000000000,0.252734000000000,0.252734000000000,0.263932000000000,0.263932000000000,0.285114000000000,0.285114000000000,0.148380000000000,0.148380000000000,0.152059000000000,0.152059000000000,0.162185000000000,0.162185000000000,0.150000000000000,0.430423000000000,0.430423000000000,0.450000000000000,0.173607000000000,0.173607000000000,0.250000000000000,-0.450000000000000,-0.330422000000000,-0.330422000000000,-0.350000000000000,-0.151562000000000,-0.271394000000000,-0.151562000000000,-0.152734000000000,-0.152734000000000,-0.163932000000000,-0.163932000000000,-0.185114000000000,-0.185114000000000,-0.271394000000000,-0.241595000000000,-0.241595000000000,-0.273607000000000,-0.273607000000000,-0.250000000000000,-0.150000000000000,0.0500000000000000,0.0500000000000000,-0.0736070000000001,-0.0736070000000001)
aggdata_topo$electrode<-c('AF3','AF4','AF7','AF8','AFz','C1','C2','C3','C4','C5','C6','CP1','CP2','CP3','CP4','CP5','CP6','CPz','Cz','F1','F2','F3','F4','F5','F6','F7','F8','FC1','FC2','FC3','FC4','FC5','FC6','FCz','Fp1','Fp2','Fpz','FT7','FT8','Fz','Iz','O1','O2','Oz','P1','P10','P2','P3','P4','P5','P6','P7','P8','P9','PO3','PO4','PO7','PO8','POz','Pz','T7','T8','TP7','TP8')


topoplot(aggdata_topo)

