---
title: "VAS_Calmness"
author: "Elaine P."
date: "26/05/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(ggpubr)
library(car)
library(haven)
library(data.table)
library(visreg)
library(dplyr)
library(tidyr)
library(reshape2)
library(reshape)
library(rstatix)
library(readxl)

VAS_calmness_exclusions <- read_excel("../Tables/VAS_calmness_exclusions.xlsx")

VAS_calmness_exclusions <- select(VAS_calmness_exclusions, -c(1,...15, ...16))

names(VAS_calmness_exclusions) <- c("Participant","MPH_1", "MPH_2", "MPH_3", "ATM_1", "ATM_2", "ATM_3", "CIT_1", "CIT_2", "CIT_3", "PLA_1", "PLA_2", "PLA_3")

VAS_calmness_exclusions$Participant <- as.factor(VAS_calmness_exclusions$Participant)

calmness.long <- melt(as.data.frame(VAS_calmness_exclusions), id.vars = "Participant", variable.name = "treatment", value.name = "rating")

names(calmness.long)[names(calmness.long) == "variable"] <- "treatment"
names(calmness.long)[names(calmness.long) == "value"] <- "rating"

## separate treatment and time into two different columns
calmness.long <- separate(calmness.long, "treatment", c("treatment", "time"), sep = "_")
 
##change treatment and time to factors 
calmness.long$time <- as.factor(calmness.long$time)
calmness.long$treatment <- as.factor(calmness.long$treatment)

```

```{r}
##mean and SD
calmness.long %>% group_by(treatment) %>% get_summary_stats(rating, type = "mean_sd")
calmness.mean <- ggplot(calmness.long, aes(treatment, rating)) +
    stat_summary(fun.data = mean_cl_normal) +
    theme_pubr()
print(calmness.mean)

##outliers
calmness.long %>% group_by(treatment) %>% identify_outliers(rating)

##normality 
calmness.long %>%
  group_by(treatment) %>%
  shapiro_test(rating)
ggqqplot(calmness.long, "rating", facet.by = "treatment")

## linearity assumption 
library(GGally)
linearity.calmness <- calmness.long %>%
  select(rating, treatment) %>%
  group_by(treatment) %>%
  doo(~ggpairs(.) + theme_bw(), result = "plots")
linearity.calmness

linearity.calmness$plots

## homogeneity of variance 
leveneTest(rating ~ treatment, data = calmness.long)
```
No extreme outliers were found.
Only citalopram was found to be normally distributed (p = .09) according to the Shapiro-Whilk test but upon inspection of the qqplots, none of the treatments differed significantly from the expected distirbution.
Insignificant results were obtained for Levene's test (p = .096) and thus, homogeneity of variance was not violated.

```{r}
##One-Way ANOVA Test
calmness.anova <- anova_test(calmness.long, rating ~ treatment, dv = rating, wid = Participant)
get_anova_table(calmness.anova)

##boxplot
bxp.calmness <- ggboxplot(
  calmness.long, x = "treatment", y = "rating",
  color = "time", palette = "jco")
bxp.calmness

##Pair-wise T-test
pwc.calmness <- calmness.long %>% pairwise_t_test(rating ~ treatment, paired = FALSE, p.adjust.method = "bonferroni")
pwc.calmness

```
No significance was found in the ANOVA and pair-wise t-test


```{r}
## summary statistics 
sum.calmness <- calmness.long %>%
  group_by(treatment, time) %>%
  get_summary_stats(rating, type = "mean_sd")
sum.calmness

##two-way repeated measures ANOVA 
calmness.aov <- anova_test(
  data = calmness.long, dv = rating, wid = Participant,
  within = c(treatment, time))
get_anova_table(calmness.aov)

## Effect of treatment at each time point
one.way.calmness <- calmness.long %>%
  group_by(time) %>%
  anova_test(dv = rating, wid = Participant, within = treatment) %>%
  get_anova_table() %>%
  adjust_pvalue(method = "bonferroni")
one.way.calmness

# Pairwise comparisons between treatment groups
pwc.calmness1 <-calmness.long %>%
  group_by(time) %>%
  pairwise_t_test(
    rating ~ treatment, paired = FALSE,
    p.adjust.method = "bonferroni")
pwc.calmness1

# Effect of time at each level of treatment
one.way.calmness1 <- calmness.long %>%
  group_by(treatment) %>%
  anova_test(dv = rating, wid = Participant, within = time) %>%
  get_anova_table() %>%
  adjust_pvalue(method = "bonferroni")
one.way.calmness1

# Pairwise comparisons between time points
pwc.calmness2 <- calmness.long %>%
  group_by(treatment) %>%
  pairwise_t_test(
    rating ~ time, paired = TRUE,
    p.adjust.method = "bonferroni"
    )
pwc.calmness2
```

-Anova table showed that time (p = .013) and treatment and time (p = .015) had a significant effect on calmness.
-Treatment was only found to have a significant effect on calmness during time 2 (p = .035)
-No significant differences in rating were found between treatment groups 
- Time had a significant effect on MPH (p = .003)
-MPH was found to have a significant effect on calmness rating from times 1 to 2 (p =.006 ) and times 1 to 3 (p = .003)

```{r}
calmness.graph <- ggplot(calmness.long, aes(x = time, y = rating, fill = treatment)) +
  geom_flat_violin(aes(fill = treatment), position = position_nudge(x = .15, y = 0), adjust = 1.5, trim = FALSE, alpha = .25, colour = NA) +
  geom_point(aes(x = as.numeric(time)-.225, y = rating, colour = treatment), position = position_jitter(width = .05), size = .25, shape = 20)  + geom_boxplot(aes(x = time, y = rating, fill = treatment), outlier.shape = NA, alpha = .5, width = .225, colour = "black") +
  geom_line(data = sum.calmness, aes(x = as.numeric(time)+.1, y = mean, group = treatment, colour = treatment), linetype = 3, size = .6) + geom_point(data = sum.calmness, aes(x = as.numeric(time)+.1, y = mean, group = treatment, colour = treatment), shape = 18) +
  scale_colour_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2")+
  ggtitle("Reported levels of calmness across time and treatment")

calmness.graph
```
*** if probem occurs in geom_flat_violin : type in console: source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R") 